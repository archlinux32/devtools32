#!/bin/bash

shopt -s extglob

m4_include(lib/common.sh)

# Source makepkg.conf; fail if it is not found
if [[ -r '/etc/makepkg.conf' ]]; then
	source '/etc/makepkg.conf'
else
	die '/etc/makepkg.conf not found!'
fi

# Source user-specific makepkg.conf overrides
if [[ -r ~/.makepkg.conf ]]; then
	source ~/.makepkg.conf
fi

if [[ ! -f PKGBUILD ]]; then
	die 'This must be run in the directory of a built package.'
fi

. ./PKGBUILD
if [[ $arch == 'any' ]]; then
	CARCH='any'
fi

STARTDIR=$(pwd)
TEMPDIR=$(mktemp -d --tmpdir checkpkg-script.XXXX)

for _pkgname in "${pkgname[@]}"; do
  pkgfile=(${_pkgname}-$(get_full_version $_pkgname)-${CARCH}.pkg.tar?(.?z))
	if (( ${#pkgfile[*]} != 1 )); then
		die 'Ambiguous package name: %s\n' "${pkgfile[*]}"
	fi

	if [[ -f "$STARTDIR/$pkgfile" ]]; then
		ln -s "$STARTDIR/$pkgfile" "$TEMPDIR/$pkgfile"
	elif [[ -f "$PKGDEST/$pkgfile" ]]; then
		ln -s "$PKGDEST/$pkgfile" "$TEMPDIR/$pkgfile"
	else
		die "File \"%s\" doesn't exist" "$pkgfile"
	fi

	pkgurl=$(pacman -Spdd --print-format '%l' --noconfirm "$_pkgname")

	if [[ $? -ne 0 ]]; then
		die "Couldn't download previous package for %s." "$_pkgname"
	fi

	oldpkg=${pkgurl##*://*/}

	if [[ ${oldpkg##*/} = ${pkgfile##*/} ]]; then
		die "The built package (%s) is the one in the repo right now!" "$_pkgname"
	fi

	if [[ ! -f $oldpkg ]]; then
		if [[ $pkgurl = file://* ]]; then
			ln -s "${pkgurl#file://}" "${pkgurl##file://*/}"
		elif [[ -f "$PKGDEST/$oldpkg" ]]; then
			ln -s "$PKGDEST/$oldpkg" "$oldpkg"
		elif [[ -f "$STARTDIR/$oldpkg" ]]; then
			ln -s "$STARTDIR/$oldpkg" "$oldpkg"
		else
			curl -fsLC - --retry 3 --retry-delay 3 -o "$oldpkg" "$pkgurl"
		fi
	fi

	bsdtar tf "$oldpkg" | sort > "$TEMPDIR/filelist-$_pkgname-old"
	bsdtar tf "$pkgfile" | sort > "$TEMPDIR/filelist-$_pkgname"

	sdiff -s "$TEMPDIR/filelist-$_pkgname-old" "$TEMPDIR/filelist-$_pkgname"

	if diff "$TEMPDIR/filelist-$_pkgname"{-old,} | grep '\.so' &>/dev/null; then
		mkdir -p "$TEMPDIR/pkg"
		bsdtar -C "$TEMPDIR" xf ../"$pkgfile" #> /dev/null
		diff "$TEMPDIR/filelist-$_pkgname-old" "$TEMPDIR/filelist-$_pkgname" | awk '/>.*\.so/{$1 = ""; print $0}' | while read i; do
			echo "${i}: " "$(objdump -p "$i" | grep SONAME)"
		done
	else
		msg "No soname differences for %s." "$_pkgname"
	fi
done

msg "Files saved to %s" "$TEMPDIR"
